<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estado de Habitaciones - Hotel Premier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }

        /* --- ESTILOS GRILLA --- */
        .table-container {
            max-height: 450px;
            overflow: auto;
            border: 1px solid #e5e7eb;
        }

        .sticky-header th {
            position: sticky; top: 0; z-index: 20;
            background-color: #f3f4f6; border-bottom: 2px solid #d1d5db;
        }

        .sticky-col {
            position: sticky; left: 0; z-index: 30;
            background-color: #f9fafb; border-right: 2px solid #d1d5db;
        }

        .sticky-header th.sticky-col {
            z-index: 40; background-color: #e5e7eb;
        }

        /* COLORES ESTADOS */
        .estado-OCUPADA { background-color: #dc2626; }
        .estado-RESERVADA { background-color: #facc15; }
        .estado-LIBRE { background-color: #07672a; }

        /* Selección Visual */
        td.seleccionada {
            box-shadow: inset 0 0 0 4px #3b82f6 !important;
            opacity: 1 !important;
        }

        td { height: 40px; min-width: 60px; }

        /* --- MODAL CONFIRMACIÓN GENÉRICO --- */
        .confirmation-dialog {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 10000;
        }
        .confirmation-dialog.active { display: flex; }

        .confirmation-content {
            background: white; border-radius: 8px; padding: 30px;
            max-width: 500px; width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); text-align: center;
        }

        /* Se eliminó el CSS viejo del modal específico para usar el genérico */
    </style>
</head>
<body>

<nav class="navbar bg-white/95 px-8 py-4 shadow-md flex justify-between items-center mb-8">
    <div class="text-2xl font-bold text-[#667eea] flex items-center gap-2">
        <i class="fas fa-hotel"></i> Hotel Premier
    </div>
    <div class="flex items-center gap-4">
        <span class="text-gray-700">Bienvenido, <strong sec:authentication="name">Usuario</strong></span>
        <form th:action="@{/logout}" method="post" class="inline">
            <button type="submit" class="px-5 py-2 bg-[#764ba2] text-white rounded hover:bg-red-600 transition text-sm font-bold">Cerrar Sesión</button>
        </form>
    </div>
</nav>

<div class="max-w-[1200px] mx-auto bg-white rounded-lg shadow-2xl overflow-hidden p-8 relative mb-10">

    <div class="border-b border-gray-200 pb-4 mb-6 flex justify-between items-center">
        <h2 class="text-xl font-bold text-gray-800 uppercase tracking-wide">
            Estado de Habitaciones
        </h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6 items-end bg-gray-50 p-5 rounded-lg border border-gray-200">
        <div>
            <label class="block font-bold text-xs mb-2 uppercase text-gray-600">Desde Fecha</label>
            <input type="date" id="desde" class="border border-gray-300 rounded p-2 w-full focus:ring-2 focus:ring-[#667eea] outline-none text-sm">
        </div>
        <div>
            <label class="block font-bold text-xs mb-2 uppercase text-gray-600">Hasta Fecha</label>
            <input type="date" id="hasta" class="border border-gray-300 rounded p-2 w-full focus:ring-2 focus:ring-[#667eea] outline-none text-sm">
        </div>
        <div>
            <label class="block font-bold text-xs mb-2 uppercase text-gray-600">Tipo Habitación</label>
            <select id="tipo" class="border border-gray-300 rounded p-2 w-full focus:ring-2 focus:ring-[#667eea] outline-none bg-white text-sm">
                <option value="">Todas las habitaciones</option>
                <option th:each="t : ${tiposHabitacion}" th:value="${t}" th:text="${t}"></option>
            </select>
        </div>
        <div>
            <button onclick="cargarGrilla()" class="bg-[#667eea] hover:bg-[#5a6fd6] text-white font-bold py-2 px-6 rounded w-full transition shadow uppercase text-sm flex justify-center items-center gap-2">
                <i class="fas fa-search"></i> BUSCAR
            </button>
        </div>
    </div>

    <div id="errorMsg" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4 text-sm font-bold shadow-sm rounded-r flex items-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="errorText"></span>
    </div>

    <div class="table-container relative shadow-inner bg-gray-100 rounded mb-6">
        <table class="w-full text-center border-collapse bg-white">
            <thead class="text-gray-700 uppercase text-xs font-bold sticky-header">
            <tr id="headerRow">
                <th class="p-3 sticky-col min-w-[120px] shadow-sm text-gray-600 bg-gray-100 z-40">DÍAS</th>
            </tr>
            </thead>
            <tbody id="bodyRows" class="text-sm">
            <tr>
                <td colspan="10" class="p-12 text-gray-400 italic text-center">
                    Seleccione un rango de fechas y presione BUSCAR.
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="flex flex-col items-center border-t border-gray-200 pt-4">
        <div class="text-sm text-gray-800 mb-3 font-medium tracking-wide text-center">
            <span class="font-bold">IE</span> - Individual Estándar <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">DE</span> - Doble Estándar <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">DS</span> - Doble Superior <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">SFP</span> - Superior Family Plan <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">SD</span> - Suite Doble
        </div>
        <div class="flex gap-10 text-sm font-bold text-gray-700 uppercase">
            <div class="flex items-center">
                <div class="w-5 h-5 bg-[#dc2626] rounded-full mr-2 shadow-sm border border-gray-200"></div> Ocupada
            </div>
            <div class="flex items-center">
                <div class="w-5 h-5 bg-[#facc15] rounded-full mr-2 shadow-sm border border-gray-200"></div> Reservada
            </div>
            <div class="flex items-center">
                <div class="w-5 h-5 bg-[#07672a] rounded-full mr-2 shadow-sm border border-gray-200"></div> Libre
            </div>
        </div>
    </div>

    <div class="mt-8 flex justify-end gap-3 border-t border-gray-100 pt-4">
        <button id="btnAccion"
                class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed uppercase"
                th:text="${textoBoton}" disabled>
        </button>

        <a href="/menu-principal" class="btn btn-secondary uppercase flex items-center">
            Cancelar
        </a>
    </div>

    <div id="modalReserva" class="confirmation-dialog">
        <div class="confirmation-content">
            <h3 class="text-lg font-bold text-black mb-2">⚠️ Habitación Reservada</h3>
            <p class="text-gray-600 mb-4 text-sm">
                Existe una reserva activa para la fecha y habitación seleccionadas.
            </p>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 text-left inline-block w-full">
                <div class="mb-3">
                    <span class="block text-xs font-bold text-gray-500 uppercase mb-1">Apellido y Nombre</span>
                    <span class="text-lg font-semibold text-gray-800">
                    <span id="modalApellido"></span>, <span id="modalNombre"></span>
                </span>
                </div>
                <div>
                    <span class="block text-xs font-bold text-gray-500 uppercase mb-1">Teléfono de Contacto</span>
                    <span id="modalTelefono" class="text-base font-medium text-gray-800"></span>
                </div>
            </div>

            <div class="confirmation-buttons flex justify-end gap-3 mt-4 w-full">
                <button id="btnOcuparIgual" class="btn btn-primary">OCUPAR IGUAL</button>
                <button id="btnVolverReserva" class="btn btn-secondary">VOLVER</button>
            </div>
        </div>
    </div>

    <div id="availabilityModal" class="confirmation-dialog">
        <div class="confirmation-content">
            <h3 class="text-lg font-bold text-black mb-4">Atención</h3>
            <p class="text-gray-700 mb-6">
                Las habitaciones seleccionadas no están “Disponibles” para el periodo indicado.
            </p>
            <div class="confirmation-buttons">
                <button onclick="cerrarModal('availabilityModal')" class="btn btn-secondary">VOLVER</button>
            </div>
        </div>
    </div>

</div>

<script>
    const inputDesde = document.getElementById('desde');
    const inputHasta = document.getElementById('hasta');
    const inputTipo = document.getElementById('tipo');
    const btnAccion = document.getElementById('btnAccion');
    const errorMsg = document.getElementById('errorMsg');
    const errorText = document.getElementById('errorText');

    let gridDataGlobal = null;

    // --- 1. Cargar Grilla ---
    async function cargarGrilla() {
        const desde = inputDesde.value;
        const hasta = inputHasta.value;
        const tipo = inputTipo.value;

        if (!desde) return mostrarError("Debe ingresar la fecha 'Desde'.", inputDesde);
        if (!hasta) return mostrarError("Debe ingresar la fecha 'Hasta'.", inputHasta);
        if (desde > hasta) return mostrarError("La fecha 'Hasta' no puede ser anterior a 'Desde'.", inputHasta);
        mostrarError(null);

        try {
            let url = `/api/habitaciones/estados?desde=${desde}&hasta=${hasta}`;
            if (tipo) url += `&tipo=${tipo}`;

            const res = await fetch(url);
            if (!res.ok) {
                const msg = await res.text();
                mostrarError(msg, inputDesde);
                limpiarTabla();
                return;
            }

            const data = await res.json();
            gridDataGlobal = data;
            renderizar(data);
            btnAccion.disabled = false;

        } catch (e) {
            console.error(e);
            mostrarError("Error de conexión.", null);
        }
    }

    // --- 2. Renderizar ---
    function renderizar(data) {
        const header = document.getElementById('headerRow');
        const body = document.getElementById('bodyRows');
        window.habitacionesMap = data.idsHabitaciones; // Guardar mapa global

        header.innerHTML = '<th class="p-3 sticky-col border border-gray-300 shadow-sm bg-gray-100 z-40 text-gray-600">DÍAS</th>';

        if (data.nombresHabitaciones.length === 0) {
            body.innerHTML = '<tr><td colspan="10" class="p-8 text-center text-gray-500">No hay habitaciones.</td></tr>';
            return;
        }

        data.nombresHabitaciones.forEach(name => {
            header.innerHTML += `<th class="p-2 border border-gray-300 min-w-[80px] bg-gray-200 text-gray-700 cursor-pointer hover:bg-gray-300 transition" onclick="seleccionarColumna('${name}')" title="Click para seleccionar toda la columna">${name}</th>`;
        });

        body.innerHTML = '';
        data.filas.forEach(fila => {
            let rowHtml = `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-2 border border-gray-300 sticky-col bg-white font-mono text-xs font-bold text-gray-600 shadow-sm">${formatoFecha(fila.fecha)}</td>`;

            data.nombresHabitaciones.forEach(hab => {
                const estado = fila.estadosPorHabitacion[hab];
                const habitacionId = data.idsHabitaciones[hab];

                let claseColor = 'estado-LIBRE';
                if (estado === 'OCUPADA') claseColor = 'estado-OCUPADA';
                else if (estado === 'RESERVADA') claseColor = 'estado-RESERVADA';

                rowHtml += `<td class="border border-gray-300 cursor-pointer ${claseColor} opacity-90 hover:opacity-100 transition"
                                data-habitacion="${hab}"
                                data-habitacion-id="${habitacionId}"
                                data-estado="${estado}"
                                onclick="gestionarClickCelda(this, '${hab}', '${fila.fecha}', '${estado}')">
                            </td>`;
            });
            rowHtml += '</tr>';
            body.insertAdjacentHTML('beforeend', rowHtml);
        });
    }

    // --- 3. Click en Celda / Columna ---
    function gestionarClickCelda(celda, nombreHab, fechaClickeada, estadoClickeado) {
        const contexto = "[[${contexto}]]";

        if (contexto === 'reservar') {
            seleccionarColumna(nombreHab);
            return;
        }

        if (contexto === 'ocupar') {

            let tieneReserva = false;
            let fechaDeLaReserva = null;
            let estaOcupada = false;

            if (gridDataGlobal && gridDataGlobal.filas) {
                for (const fila of gridDataGlobal.filas) {
                    const estadoDia = fila.estadosPorHabitacion[nombreHab];

                    if (estadoDia === 'OCUPADA') {
                        estaOcupada = true;
                        break;
                    }
                    if (estadoDia === 'RESERVADA' && !tieneReserva) {
                        tieneReserva = true;
                        fechaDeLaReserva = fila.fecha;
                    }
                }
            }

            if (estaOcupada) {
                mostrarError("No puede ocupar la habitación " + nombreHab + " porque está ocupada en el rango seleccionado.", null);
                return;
            }

            seleccionarColumna(nombreHab);

            if (tieneReserva) {
                console.log("Conflicto de reserva detectado en fecha: " + fechaDeLaReserva);
                mostrarModalReserva(nombreHab, fechaDeLaReserva);
            }
        }
    }

    function seleccionarColumna(nombreHab) {
        const contexto = "[[${contexto}]]";

        if (contexto !== 'reservar' && contexto !== 'ocupar') return;

        if (contexto === 'ocupar') {
            document.querySelectorAll('td.seleccionada').forEach(td => {
                if (td.dataset.habitacion !== nombreHab) {
                    td.classList.remove('seleccionada');
                }
            });
        }

        const celdas = document.querySelectorAll(`td[data-habitacion="${nombreHab}"]`);
        const marcar = !celdas[0].classList.contains('seleccionada');

        celdas.forEach(celda => {
            if (marcar) celda.classList.add('seleccionada');
            else celda.classList.remove('seleccionada');
        });

        mostrarError(null);
    }

    // --- 4. Botón Acción Principal ---
    btnAccion.addEventListener('click', () => {
        const contexto = "[[${contexto}]]";
        const celdasSeleccionadas = document.querySelectorAll('td.seleccionada');

        if (celdasSeleccionadas.length === 0) {
            mostrarError("Debe seleccionar al menos una habitación.", null);
            return;
        }

        if (contexto === 'reservar') {
            // Validación Disponibilidad
            let hayConflicto = false;
            for (let celda of celdasSeleccionadas) {
                if (celda.getAttribute('data-estado') !== 'LIBRE') {
                    hayConflicto = true;
                    break;
                }
            }

            if (hayConflicto) {
                document.getElementById('availabilityModal').classList.add('active');
                return;
            }

            const idsHabitaciones = [...new Set(Array.from(celdasSeleccionadas).map(td => td.dataset.habitacionId))];

            sessionStorage.setItem('reservaData', JSON.stringify({
                idsHabitaciones: idsHabitaciones.map(id => parseInt(id)),
                fechaIngreso: inputDesde.value,
                fechaEgreso: inputHasta.value
            }));

            window.location.href = '/reserva/confirmar';

        } else if (contexto === 'ocupar') {
            // Lógica para 'Ocupar' (caso normal, habitación LIBRE)
            const idHabitacion = celdasSeleccionadas[0].dataset.habitacionId;
            const nombreHabitacion = celdasSeleccionadas[0].dataset.habitacion;

            let ocupada = false;
            celdasSeleccionadas.forEach(td => {
                if (td.dataset.estado === 'OCUPADA') ocupada = true;
            });

            if (ocupada) {
                alert("No puede ocupar una habitación que ya está ocupada.");
                return;
            }

            const dataOcupacion = {
                idHabitacion: parseInt(idHabitacion),
                nombreHabitacion: nombreHabitacion,
                fechaIngreso: inputDesde.value,
                fechaEgreso: inputHasta.value
            };

            sessionStorage.setItem('ocupacionData', JSON.stringify(dataOcupacion));
            window.location.href = '/habitacion/ocupar';
        }
    });

    // --- Modales y Utilidades ---
    // Versión robusta para evitar errores si la API falla o el nombre tiene espacios
    async function mostrarModalReserva(nombre, fecha) {
        let datos = {
            apellido: "NO DISPONIBLE",
            nombre: " - ",
            telefono: "Consulte en recepción"
        };

        try {
            // Usamos encodeURIComponent por si el nombre tiene espacios
            const res = await fetch(`/api/habitaciones/reserva-detalle?nombre=${encodeURIComponent(nombre)}&fecha=${fecha}`);

            if (res.ok) {
                datos = await res.json();
            } else {
                console.warn("El backend no devolvió detalles, usando valores por defecto.");
            }

        } catch (e) {
            console.error("Error de conexión:", e);
        }

        // 1. Llenar el modal
        document.getElementById('modalApellido').textContent = datos.apellido || 'Sin Datos';
        document.getElementById('modalNombre').textContent = datos.nombre || '';
        document.getElementById('modalTelefono').textContent = datos.telefono || '';

        // 2. Configurar Botón: OCUPAR IGUAL
        const btnOcuparIgual = document.getElementById('btnOcuparIgual');
        const newBtnOcupar = btnOcuparIgual.cloneNode(true);
        btnOcuparIgual.parentNode.replaceChild(newBtnOcupar, btnOcuparIgual);

        newBtnOcupar.onclick = function() {
            const dataOcupacion = {
                idHabitacion: parseInt(window.habitacionesMap[nombre]),
                nombreHabitacion: nombre,
                fechaIngreso: document.getElementById('desde').value,
                fechaEgreso: document.getElementById('hasta').value
            };
            sessionStorage.setItem('ocupacionData', JSON.stringify(dataOcupacion));
            window.location.href = '/habitacion/ocupar';
        };

        // 3. Configurar Botón: VOLVER
        const btnVolver = document.getElementById('btnVolverReserva');
        const newBtnVolver = btnVolver.cloneNode(true);
        btnVolver.parentNode.replaceChild(newBtnVolver, btnVolver);

        newBtnVolver.onclick = function() {
            cerrarModal('modalReserva');
            seleccionarColumna(nombre);
        };

        // 4. Mostrar el Modal
        document.getElementById('modalReserva').classList.add('active');
    }

    function cerrarModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function formatoFecha(iso) { const [y, m, d] = iso.split('-'); return `${d}/${m}/${y}`; }

    function mostrarError(msg, elementToFocus) {
        if (msg) {
            errorText.textContent = msg;
            errorMsg.classList.remove('hidden');
            if(elementToFocus) elementToFocus.focus();
        } else {
            errorMsg.classList.add('hidden');
        }
    }

    function limpiarTabla() {
        document.getElementById('bodyRows').innerHTML = '<tr><td colspan="10" class="p-12 text-gray-400 italic text-center">Corrija los errores.</td></tr>';
        btnAccion.disabled = true;
    }
</script>
</body>
</html>