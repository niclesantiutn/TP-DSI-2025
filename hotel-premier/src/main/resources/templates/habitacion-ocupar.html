<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ocupar Habitación - Selección de Huéspedes</title>
    <style>

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        .body {
            padding: 30px;
        }
        .search-box {
            background: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* ESTILOS DE BOTONES */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; color: white; transition: background 0.2s; }
        .btn-primary { background: #667eea; }
        .btn-primary:hover { background: #5a6fd6; }

        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }

        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }

        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }

        .btn-add { background: #17a2b8; color: white; }
        .btn-add:hover { background: #138496; }

        .lists-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .list-box { border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-height: 150px; background: #fff; }
        .list-header { font-weight: bold; margin-bottom: 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        .selected-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid transparent; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #444; }
        tr:hover { background-color: #f8f9fa; }

        /* ESTILOS DEL MODAL (Popup) */
        .confirmation-dialog {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Oculto por defecto */
            justify-content: center; align-items: center;
            z-index: 10000;
        }
        .confirmation-dialog.active { display: flex; }

        .confirmation-content {
            background: white; border-radius: 8px; padding: 30px;
            max-width: 500px; width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); text-align: center;
        }

        /* Estilo específico para el modal de éxito (Verde) */
        .success-dialog { background-color: #d4edda; border: 2px solid #28a745; }
        .success-dialog h3 { color: #155724; margin: 0 0 15px 0; font-size: 24px; }
        .success-dialog p { color: #155724; font-weight: 500; font-size: 16px; margin-bottom: 20px; }

        .confirmation-buttons { display: flex; justify-content: center; }
        .confirmation-buttons .btn { min-width: 100px; }

        /* Estilo específico para el modal de Error (Rojo Suave) */
        .error-dialog { background-color: #f8d7da; border: 2px solid #dc3545; }
        .error-dialog h3 { color: #721c24; margin: 0 0 15px 0; font-size: 24px; }
        .error-dialog p { color: #721c24; font-weight: 500; font-size: 16px; margin-bottom: 20px; }

    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>OCUPAR HABITACIÓN</h2>
        <p id="infoHabitacion" style="color: #666; font-size: 0.9em; margin-top: 5px;"></p>
    </div>

    <div class="body">
        <div class="search-box">
            <h3 style="margin-top:0; color: #444;">Buscar Personas</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="busquedaApellido" placeholder="Apellido" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <input type="text" id="busquedaNombre" placeholder="Nombre" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <input type="text" id="busquedaDoc" placeholder="Documento" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" maxlength="15">

                <button class="btn btn-primary" onclick="buscarHuespedes()">BUSCAR</button>
            </div>

            <table id="tablaResultados">
                <thead><tr><th>Apellido</th><th>Nombre</th><th>Documento</th><th>Acción</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="lists-container">
            <div class="list-box" id="boxResponsable">
                <div class="list-header">RESPONSABLE (Titular)</div>
                <div id="responsableSeleccionado" style="color: #999; font-style: italic; padding: 10px;">Ninguno seleccionado</div>
            </div>

            <div class="list-box" id="boxAcompanantes">
                <div class="list-header">ACOMPAÑANTES</div>
                <div id="listaAcompanantes"></div>
            </div>
        </div>

        <div style="margin-top: 30px; text-align: right; border-top: 1px solid #eee; padding-top: 20px;">
            <button class="btn btn-secondary" onclick="window.history.back()" style="margin-right: 10px;">VOLVER</button>
            <button class="btn btn-success" onclick="confirmarOcupacion()">CONFIRMAR OCUPACIÓN</button>
        </div>

        <div id="errorDialog" class="confirmation-dialog">
            <div class="confirmation-content error-dialog">
                <h3>⚠️ Atención</h3>
                <p id="textoError">Error desconocido</p>
                <div class="confirmation-buttons">
                    <button type="button" class="btn btn-danger" onclick="cerrarModalError()">ENTENDIDO</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="successDialog" class="confirmation-dialog">
    <div class="confirmation-content success-dialog">
        <h3>¡Éxito!</h3>
        <p>¡Ocupación registrada exitosamente!</p>
        <div class="confirmation-buttons">
            <button type="button" class="btn btn-success" id="btnSuccessOk">ACEPTAR</button>
        </div>
    </div>
</div>

<script>
    // --- 1. Inicialización y Event Listeners de Validación ---
    document.addEventListener('DOMContentLoaded', function() {
        // Validar Apellido y Nombre: Solo letras y espacios, convertir a mayúsculas
        ['busquedaApellido', 'busquedaNombre'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function() {
                // Reemplaza todo lo que NO sea letra (incluyendo acentos y ñ) o espacio por vacío
                let valorLimpio = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '');
                this.value = valorLimpio.toUpperCase();
            });
        });

        // Validar Documento: Solo números
        const docInput = document.getElementById('busquedaDoc');
        docInput.addEventListener('input', function() {
            // Reemplaza todo lo que NO sea número por vacío
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Configurar botón del Modal de Éxito
        document.getElementById('btnSuccessOk').addEventListener('click', function() {
            window.location.href = '/menu-principal';
        });
    });

    // 2. Recuperar datos de la sesión
    const ocupacionData = JSON.parse(sessionStorage.getItem('ocupacionData'));

    if (!ocupacionData) {
        alert("No hay datos de ocupación. Volviendo al menú.");
        window.location.href = '/menu-principal';
    }

    // Mostrar info en la cabecera
    document.getElementById('infoHabitacion').textContent =
        `Habitación: ${ocupacionData.nombreHabitacion} | Desde: ${ocupacionData.fechaIngreso} | Hasta: ${ocupacionData.fechaEgreso}`;

    // Variables de estado
    let responsable = null;
    let acompanantes = [];

    // --- FUNCIÓN DE BÚSQUEDA ---
    async function buscarHuespedes() {
        const apellido = document.getElementById('busquedaApellido').value;
        const nombre = document.getElementById('busquedaNombre').value;
        const doc = document.getElementById('busquedaDoc').value;

        const params = new URLSearchParams();
        if(apellido) params.append('apellido', apellido);
        if(nombre) params.append('nombre', nombre);
        if(doc) params.append('documento', doc);

        try {
            const res = await fetch('/api/personas/huesped/buscar?' + params.toString(), {
                method: 'POST'
            });

            if (!res.ok) {
                console.error("Error API:", res.status);
                return;
            }

            const data = await res.json();
            const tbody = document.querySelector('#tablaResultados tbody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #666;">No se encontraron resultados</td></tr>';
                return;
            }

            data.forEach(h => {
                const jsonString = JSON.stringify(h).replace(/"/g, '&quot;');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td>${h.apellido}</td>
                        <td>${h.nombre}</td>
                        <td>${h.documento}</td>
                        <td>
                            <button class="btn btn-primary" style="font-size: 0.8em; margin-right:5px;"
                                    onclick="seleccionarResponsable(${jsonString})">Ser Responsable</button>
                            <button class="btn btn-add" style="font-size: 0.8em;"
                                    onclick="agregarAcompanante(${jsonString})">+ Acomp</button>
                        </td>
                    `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error(error);
            alert("Error al buscar huéspedes.");
        }
    }

    // --- SELECCIONAR RESPONSABLE ---
    function seleccionarResponsable(huesped) {
        if (acompanantes.some(a => a.id === huesped.id)) {
            alert("Esta persona ya está en la lista de acompañantes. Quítela de allí primero.");
            return;
        }

        responsable = huesped;
        const div = document.getElementById('responsableSeleccionado');
        div.innerHTML = `
                <div class="selected-item" style="background: #d1fae5; border-color: #34d399; padding: 10px;">
                    <div>
                        <div style="font-weight:bold; color: #065f46;">${huesped.apellido}, ${huesped.nombre}</div>
                        <div style="font-size: 0.85em; color: #047857;">DNI: ${huesped.documento}</div>
                    </div>
                </div>
            `;
    }

    // --- AGREGAR ACOMPAÑANTE ---
    function agregarAcompanante(huesped) {
        if (responsable && responsable.id === huesped.id) {
            alert("Esta persona ya es el Responsable titular.");
            return;
        }

        const yaExiste = acompanantes.some(a => a.id === huesped.id);
        if (yaExiste) {
            alert("Esta persona ya está agregada como acompañante.");
            return;
        }

        acompanantes.push(huesped);
        renderAcompanantes();
    }

    // --- RENDERIZAR LISTA ---
    function renderAcompanantes() {
        const container = document.getElementById('listaAcompanantes');
        container.innerHTML = '';

        acompanantes.forEach((a, index) => {
            const div = document.createElement('div');
            div.className = 'selected-item';
            div.style.cssText = "background: #e0f2f1; border: 1px solid #b2dfdb; padding: 8px;";

            div.innerHTML = `
                    <span style="color: #00695c; font-weight: 500;">${a.apellido}, ${a.nombre}</span>
                    <button class="btn btn-danger" style="padding: 2px 8px; font-size: 0.7em;"
                            onclick="quitarAcompanante(${index})">X</button>
                `;
            container.appendChild(div);
        });
    }

    function quitarAcompanante(index) {
        acompanantes.splice(index, 1);
        renderAcompanantes();
    }

    // --- CONFIRMAR OCUPACIÓN ---
    async function confirmarOcupacion() {
        if (!responsable) {
            // Usamos el nuevo modal incluso para validaciones locales
            mostrarModalError("Debe seleccionar un Responsable de Pago (Huésped Titular).");
            return;
        }

        const request = {
            idHabitacion: ocupacionData.idHabitacion,
            fechaIngreso: ocupacionData.fechaIngreso,
            fechaEgreso: ocupacionData.fechaEgreso,
            idResponsable: responsable.id,
            idsAcompaniantes: acompanantes.map(a => a.id)
        };

        try {
            const res = await fetch('/api/estadias/ocupar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            if (res.ok) {
                // ÉXITO: Limpiar datos y mostrar Modal Verde
                sessionStorage.removeItem('ocupacionData');
                document.getElementById('successDialog').classList.add('active');
            } else {
                // ERROR: Leemos el mensaje del backend y mostramos Modal Rojo
                const err = await res.json();

                // Si el backend devuelve el mensaje en 'message', lo usamos.
                // Si no, ponemos un genérico.
                let mensajeServidor = err.message || "No se pudo registrar la ocupación.";

                mostrarModalError(mensajeServidor);
            }
        } catch (e) {
            console.error(e);
            mostrarModalError("Error de conexión con el servidor");
        }
    }

    function mostrarModalError(mensaje) {
        document.getElementById('textoError').textContent = mensaje;
        document.getElementById('errorDialog').classList.add('active');
    }

    function cerrarModalError() {
        document.getElementById('errorDialog').classList.remove('active');
    }

</script>
</body>
</html>