<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estado de Habitaciones - Hotel Premier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }

        /* --- ESTILOS GRILLA --- */
        .table-container {
            max-height: 450px;
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        table {
            min-width: max-content;
            width: 100%;
        }

        .sticky-header th {
            position: sticky; top: 0; z-index: 20;
            background-color: #f3f4f6; border-bottom: 2px solid #d1d5db;
        }

        .sticky-col {
            position: sticky; left: 0; z-index: 30;
            background-color: #f9fafb; border-right: 2px solid #d1d5db;
        }

        .sticky-header th.sticky-col {
            z-index: 40; background-color: #e5e7eb;
        }

        /* COLORES ESTADOS */
        .estado-OCUPADA { background-color: #dc2626; }
        .estado-RESERVADA { background-color: #facc15; }
        .estado-LIBRE { background-color: #07672a; }

        td {
            height: 40px;
            min-width: 60px;
            width: auto;
            white-space: nowrap;
        }

        /* --- ESTILOS DE SELECCIÓN POR RANGO --- */
        td.seleccion-inicio {
            box-shadow: inset 0 0 0 4px #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.2) !important;
        }

        td.seleccion-rango {
            box-shadow: inset 0 0 0 2px #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.4) !important;
            opacity: 1 !important;
        }

        /* --- MODAL CONFIRMACIÓN GENÉRICO --- */
        .confirmation-dialog {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 10000;
        }
        .confirmation-dialog.active { display: flex; }

        .confirmation-content {
            background: white; border-radius: 8px; padding: 30px;
            max-width: 500px; width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); text-align: center;
        }

        .ocupacion-success-dialog {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center;
            z-index: 10001; flex-direction: column;
        }
        .ocupacion-success-dialog.active { display: flex; }

        .ocupacion-success-content {
            background: white; border-radius: 12px; padding: 40px;
            max-width: 600px; width: 90%; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<nav class="navbar bg-white/95 px-8 py-4 shadow-md flex justify-between items-center mb-8">
    <div class="text-2xl font-bold text-[#667eea] flex items-center gap-2">
        <i class="fas fa-hotel"></i> Hotel Premier
    </div>
    <div class="flex items-center gap-4">
        <span class="text-gray-700">Bienvenido, <strong sec:authentication="name">Usuario</strong></span>
        <form th:action="@{/logout}" method="post" class="inline">
            <button type="submit" class="px-5 py-2 bg-[#764ba2] text-white rounded hover:bg-red-600 transition text-sm font-bold">Cerrar Sesión</button>
        </form>
    </div>
</nav>

<div class="max-w-[1200px] mx-auto bg-white rounded-lg shadow-2xl overflow-hidden p-8 relative mb-10">

    <div class="border-b border-gray-200 pb-4 mb-6 flex justify-between items-center">
        <h2 class="text-xl font-bold text-gray-800 uppercase tracking-wide">
            Estado de Habitaciones
        </h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6 items-end bg-gray-50 p-5 rounded-lg border border-gray-200">
        <div>
            <label class="block font-bold text-xs mb-2 uppercase text-gray-600">Desde Fecha</label>
            <input type="date" id="desde" class="border border-gray-300 rounded p-2 w-full focus:ring-2 focus:ring-[#667eea] outline-none text-sm">
        </div>
        <div>
            <label class="block font-bold text-xs mb-2 uppercase text-gray-600">Hasta Fecha</label>
            <input type="date" id="hasta" class="border border-gray-300 rounded p-2 w-full focus:ring-2 focus:ring-[#667eea] outline-none text-sm">
        </div>
        <div>
            <label class="block font-bold text-xs mb-2 uppercase text-gray-600">Tipo Habitación</label>
            <select id="tipo" class="border border-gray-300 rounded p-2 w-full focus:ring-2 focus:ring-[#667eea] outline-none bg-white text-sm">
                <option value="">Todas las habitaciones</option>
                <option th:each="t : ${tiposHabitacion}" th:value="${t}" th:text="${t}"></option>
            </select>
        </div>
        <div>
            <button onclick="cargarGrilla()" class="bg-[#667eea] hover:bg-[#5a6fd6] text-white font-bold py-2 px-6 rounded w-full transition shadow uppercase text-sm flex justify-center items-center gap-2">
                <i class="fas fa-search"></i> BUSCAR
            </button>
        </div>
    </div>

    <div id="errorMsg" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4 text-sm font-bold shadow-sm rounded-r flex items-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="errorText"></span>
    </div>

    <div class="table-container relative shadow-inner bg-gray-100 rounded mb-6">
        <table class="w-full text-center border-collapse bg-white">
            <thead class="text-gray-700 uppercase text-xs font-bold sticky-header">
            <tr id="headerRow">
                <th class="p-3 sticky-col border border-gray-300 shadow-sm bg-gray-100 z-40 text-gray-600">DÍAS</th>
            </tr>
            </thead>
            <tbody id="bodyRows" class="text-sm">
            <tr>
                <td colspan="10" class="p-12 text-gray-400 italic text-center">
                    Seleccione un rango de fechas y presione BUSCAR.
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="flex flex-col items-center border-t border-gray-200 pt-4">
        <div class="text-sm text-gray-800 mb-3 font-medium tracking-wide text-center">
            <span class="font-bold">IE</span> - Individual Estándar <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">DE</span> - Doble Estándar <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">DS</span> - Doble Superior <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">SFP</span> - Superior Family Plan <span class="mx-2 text-gray-300">|</span>
            <span class="font-bold">SD</span> - Suite Doble
        </div>
        <div class="flex gap-10 text-sm font-bold text-gray-700 uppercase">
            <div class="flex items-center">
                <div class="w-5 h-5 bg-[#dc2626] rounded-full mr-2 shadow-sm border border-gray-200"></div> Ocupada
            </div>
            <div class="flex items-center">
                <div class="w-5 h-5 bg-[#facc15] rounded-full mr-2 shadow-sm border border-gray-200"></div> Reservada
            </div>
            <div class="flex items-center">
                <div class="w-5 h-5 bg-[#07672a] rounded-full mr-2 shadow-sm border border-gray-200"></div> Libre
            </div>
        </div>
    </div>

    <div class="mt-8 flex justify-end gap-3 border-t border-gray-100 pt-4">

        <button id="btnAccion"
                class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed uppercase"
                th:text="${textoBoton}"
                th:unless="${modoConsulta}"
                disabled>
        </button>

        <a href="/menu-principal"
           th:class="${modoConsulta} ? 'btn btn-primary uppercase flex items-center' : 'btn btn-secondary uppercase flex items-center'"
           th:text="${modoConsulta} ? 'VOLVER' : 'CANCELAR'">
        </a>
    </div>

    <div id="ocupacionSuccessDialog" class="ocupacion-success-dialog">
        <div class="ocupacion-success-content">
            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 28px;">✅ Habitación Ocupada</h2>
            <div id="ocupacionInfo" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #667eea;">
            </div>
            <p style="color: #666; font-size: 16px; margin-bottom: 10px;">La habitación ha sido marcada como ocupada</p>
            <p style="color: #667eea; font-size: 18px; font-weight: bold; margin-bottom: 30px;">
                PRESIONE CUALQUIER TECLA PARA CONTINUAR...
            </p>
            <div style="color: #999; font-size: 14px;">
                ↪ Será redirigido a la carga de huéspedes
            </div>
        </div>
    </div>

    <div id="modalReserva" class="confirmation-dialog">
        <div class="confirmation-content">
            <h3 class="text-lg font-bold text-black mb-2">⚠️ Habitación Reservada</h3>
            <p class="text-gray-600 mb-4 text-sm">Existe una reserva activa para la fecha y habitación seleccionadas.</p>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 text-left inline-block w-full">
                <div class="mb-3">
                    <span class="block text-xs font-bold text-gray-500 uppercase mb-1">Apellido y Nombre</span>
                    <span class="text-lg font-semibold text-gray-800"><span id="modalApellido"></span>, <span id="modalNombre"></span></span>
                </div>
                <div>
                    <span class="block text-xs font-bold text-gray-500 uppercase mb-1">Teléfono de Contacto</span>
                    <span id="modalTelefono" class="text-base font-medium text-gray-800"></span>
                </div>
            </div>
            <div class="confirmation-buttons flex justify-end gap-3 mt-4 w-full">
                <button id="btnOcuparIgual" class="btn btn-primary">OCUPAR IGUAL</button>
                <button id="btnVolverReserva" class="btn btn-secondary">VOLVER</button>
            </div>
        </div>
    </div>

    <div id="availabilityModal" class="confirmation-dialog">
        <div class="confirmation-content">
            <h3 class="text-lg font-bold text-black mb-4">Atención</h3>
            <p class="text-gray-700 mb-6">Las habitaciones seleccionadas no están "Disponibles" para el periodo indicado.</p>
            <div class="confirmation-buttons">
                <button onclick="cerrarModal('availabilityModal')" class="btn btn-secondary">VOLVER</button>
            </div>
        </div>
    </div>

</div>

<script>
    const inputDesde = document.getElementById('desde');
    const inputHasta = document.getElementById('hasta');
    const inputTipo = document.getElementById('tipo');
    const btnAccion = document.getElementById('btnAccion');
    const errorMsg = document.getElementById('errorMsg');
    const errorText = document.getElementById('errorText');

    let gridDataGlobal = null;
    let seleccionesActivas = new Map();

    // --- 1. Cargar Grilla ---
    async function cargarGrilla() {
        limpiarSeleccionTotal();

        const desde = inputDesde.value;
        const hasta = inputHasta.value;
        const tipo = inputTipo.value;

        if (!desde) return mostrarError("Debe ingresar la fecha 'Desde'.", inputDesde);
        if (!hasta) return mostrarError("Debe ingresar la fecha 'Hasta'.", inputHasta);
        if (desde > hasta) return mostrarError("La fecha 'Hasta' no puede ser anterior a 'Desde'.", inputHasta);
        mostrarError(null);

        try {
            let url = `/api/habitaciones/estados?desde=${desde}&hasta=${hasta}`;
            if (tipo) url += `&tipo=${tipo}`;

            const res = await fetch(url);
            if (!res.ok) {
                const msg = await res.text();
                mostrarError(msg, inputDesde);
                limpiarTabla();
                return;
            }

            const data = await res.json();
            gridDataGlobal = data;
            renderizar(data);

            if (btnAccion) {
                btnAccion.disabled = true;
            }

        } catch (e) {
            console.error(e);
            mostrarError("Error de conexión.", null);
        }
    }

    // --- 2. Renderizar ---
    function renderizar(data) {
        const header = document.getElementById('headerRow');
        const body = document.getElementById('bodyRows');
        window.habitacionesMap = data.idsHabitaciones;

        header.innerHTML = '<th class="p-3 sticky-col border border-gray-300 shadow-sm bg-gray-100 z-40 text-gray-600">DÍAS</th>';

        if (data.nombresHabitaciones.length === 0) {
            body.innerHTML = '<tr><td colspan="10" class="p-8 text-center text-gray-500">No hay habitaciones.</td></tr>';
            return;
        }

        data.nombresHabitaciones.forEach(name => {
            header.innerHTML += `<th class="p-2 border border-gray-300 min-w-[80px] bg-gray-200 text-gray-700">${name}</th>`;
        });

        body.innerHTML = '';
        data.filas.forEach(fila => {
            let rowHtml = `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-2 border border-gray-300 sticky-col bg-white font-mono text-xs font-bold text-gray-600 shadow-sm">${formatoFecha(fila.fecha)}</td>`;

            data.nombresHabitaciones.forEach(hab => {
                const estado = fila.estadosPorHabitacion[hab];
                const habitacionId = data.idsHabitaciones[hab];

                let claseColor = 'estado-LIBRE';
                if (estado === 'OCUPADA') claseColor = 'estado-OCUPADA';
                else if (estado === 'RESERVADA') claseColor = 'estado-RESERVADA';

                rowHtml += `<td class="border border-gray-300 cursor-pointer ${claseColor} opacity-90 hover:opacity-100 transition"
                                data-habitacion="${hab}"
                                data-habitacion-id="${habitacionId}"
                                data-estado="${estado}"
                                data-fecha="${fila.fecha}"
                                onclick="gestionarClickRango(this, '${hab}', '${fila.fecha}', '${estado}')"
                                ondblclick="gestionarDobleClick(this, '${hab}', '${fila.fecha}', '${estado}')">
                            </td>`;
            });
            rowHtml += '</tr>';
            body.insertAdjacentHTML('beforeend', rowHtml);
        });
    }

    // --- 3. Lógica de Selección por Rango ---
    function gestionarClickRango(celda, nombreHab, fecha, estado) {
        const contexto = "[[${contexto}]]";
        const desde = inputDesde.value;
        const hasta = inputHasta.value;

        if (contexto === 'ver') return;

        if (desde === hasta) {
            if (seleccionesActivas.has(nombreHab)) {
                deseleccionarHabitacion(nombreHab);
                return;
            }

            if (contexto === 'ocupar' && estado === 'OCUPADA') {
                mostrarError("No puede iniciar una ocupación en un día ya ocupado.");
                return;
            }

            seleccionesActivas.set(nombreHab, {
                idHabitacion: celda.getAttribute('data-habitacion-id'),
                fechaInicio: fecha,
                fechaFin: fecha,
                estado: 'COMPLETO'
            });

            pintarRango(nombreHab, fecha, fecha);
            validarTodasSelecciones();
            return;
        }

        let seleccionHab = seleccionesActivas.get(nombreHab);

        if (!seleccionHab || seleccionHab.estado === 'COMPLETO') {
            if (seleccionHab && seleccionHab.estado === 'COMPLETO') {
                limpiarSeleccionVisual(nombreHab);
            }

            if (contexto === 'ocupar' && estado === 'OCUPADA') {
                mostrarError("No puede iniciar una ocupación en un día ya ocupado.");
                return;
            }

            seleccionesActivas.set(nombreHab, {
                idHabitacion: celda.getAttribute('data-habitacion-id'),
                fechaInicio: fecha,
                fechaFin: null,
                estado: 'ESPERANDO_FIN'
            });

            celda.classList.add('seleccion-inicio');
            mostrarError(`Seleccione la fecha de FIN para la habitación ${nombreHab}.`);

        }
        else if (seleccionHab.estado === 'ESPERANDO_FIN') {
            if (fecha < seleccionHab.fechaInicio) {
                document.querySelector(`td[data-habitacion="${nombreHab}"][data-fecha="${seleccionHab.fechaInicio}"]`)
                    .classList.remove('seleccion-inicio');

                seleccionHab.fechaInicio = fecha;
                celda.classList.add('seleccion-inicio');
                seleccionesActivas.set(nombreHab, seleccionHab);
                mostrarError("Fecha de inicio actualizada. Seleccione una fecha de FIN posterior.");
                return;
            }

            seleccionHab.fechaFin = fecha;
            seleccionHab.estado = 'COMPLETO';
            seleccionesActivas.set(nombreHab, seleccionHab);

            pintarRango(nombreHab, seleccionHab.fechaInicio, seleccionHab.fechaFin);
            validarTodasSelecciones();
        }
    }

    function pintarRango(nombreHab, fInicio, fFin) {
        const inicioCelda = document.querySelector(`td[data-habitacion="${nombreHab}"][data-fecha="${fInicio}"]`);
        if (inicioCelda) inicioCelda.classList.remove('seleccion-inicio');

        const celdas = document.querySelectorAll(`td[data-habitacion="${nombreHab}"]`);
        celdas.forEach(td => {
            const fCelda = td.getAttribute('data-fecha');
            if (fCelda >= fInicio && fCelda <= fFin) {
                td.classList.add('seleccion-rango');
            } else {
                td.classList.remove('seleccion-rango');
            }
        });
    }

    function limpiarSeleccionVisual(nombreHab) {
        document.querySelectorAll(`td[data-habitacion="${nombreHab}"].seleccion-inicio`).forEach(el => el.classList.remove('seleccion-inicio'));
        document.querySelectorAll(`td[data-habitacion="${nombreHab}"].seleccion-rango`).forEach(el => el.classList.remove('seleccion-rango'));
    }

    function deseleccionarHabitacion(nombreHab) {
        limpiarSeleccionVisual(nombreHab);
        seleccionesActivas.delete(nombreHab);
        validarTodasSelecciones();
    }

    function limpiarSeleccionTotal() {
        seleccionesActivas.clear();
        document.querySelectorAll('.seleccion-inicio').forEach(el => el.classList.remove('seleccion-inicio'));
        document.querySelectorAll('.seleccion-rango').forEach(el => el.classList.remove('seleccion-rango'));
        if (btnAccion) btnAccion.disabled = true;
    }

    function esRangoValidoParaHabitacion(nombreHab, fInicio, fFin, contexto) {
        const celdas = document.querySelectorAll(`td[data-habitacion="${nombreHab}"]`);
        let esValido = true;
        celdas.forEach(td => {
            const fCelda = td.getAttribute('data-fecha');
            if (fCelda >= fInicio && fCelda <= fFin) {
                const est = td.getAttribute('data-estado');
                if (contexto === 'ocupar' && est === 'OCUPADA') esValido = false;
                if (contexto === 'reservar' && est !== 'LIBRE') esValido = false;
            }
        });
        return esValido;
    }

    function validarTodasSelecciones() {
        const contexto = "[[${contexto}]]";
        if (seleccionesActivas.size === 0) {
            if (btnAccion) btnAccion.disabled = true;
            mostrarError(null);
            return;
        }

        let conflicto = false;
        let incompleto = false;

        for (const [nombreHab, sel] of seleccionesActivas) {
            if (sel.estado !== 'COMPLETO') {
                incompleto = true; break;
            }
            if (!esRangoValidoParaHabitacion(nombreHab, sel.fechaInicio, sel.fechaFin, contexto)) {
                conflicto = true;
                mostrarError(`Esta habitacion ${nombreHab} no se puede reservar en el rango seleccionado.`);
                break;
            }
        }

        if (conflicto || incompleto) {
            if (btnAccion) btnAccion.disabled = true;
        } else {
            if (btnAccion) btnAccion.disabled = false;
            mostrarError(null);
        }
    }

    // --- 4. Atajo Doble Click ---
    function gestionarDobleClick(celda, nombreHab, fecha, estado) {
        const contexto = "[[${contexto}]]";
        const desde = inputDesde.value;
        const hasta = inputHasta.value;
        const habitacionId = celda.getAttribute('data-habitacion-id');

        if (desde !== hasta) return;
        if (fecha !== desde) return;
        if (contexto === 'ver') return;

        limpiarSeleccionTotal();

        if (contexto === 'ocupar') {
            if (estado === 'OCUPADA') {
                alert("No puede ocupar una habitación que ya está ocupada.");
                return;
            }
            if (estado === 'RESERVADA') {
                mostrarModalReserva(nombreHab, fecha);
                return;
            }
            const dataOcupacion = {
                idHabitacion: parseInt(habitacionId),
                nombreHabitacion: nombreHab,
                fechaIngreso: desde,
                fechaEgreso: hasta
            };
            sessionStorage.setItem('ocupacionData', JSON.stringify(dataOcupacion));
            window.location.href = '/habitacion/ocupar';
        }
        else if (contexto === 'reservar') {
            if (estado !== 'LIBRE') {
                document.getElementById('availabilityModal').classList.add('active');
                return;
            }
            const reservaData = [{
                idHabitacion: parseInt(habitacionId),
                nombreHabitacion: nombreHab,
                fechaIngreso: desde,
                fechaEgreso: hasta
            }];
            sessionStorage.setItem('reservaData', JSON.stringify(reservaData));
            window.location.href = '/reserva/confirmar';
        }
    }

    // --- 5. Botón Acción Principal ---
    if (btnAccion) {
        btnAccion.addEventListener('click', async () => {
            const contexto = "[[${contexto}]]";

            if (seleccionesActivas.size === 0) {
                mostrarError("Debe seleccionar al menos una habitación.");
                return;
            }

            const dataFinal = [];
            for (const [nombreHab, sel] of seleccionesActivas) {
                dataFinal.push({
                    idHabitacion: parseInt(sel.idHabitacion),
                    nombreHabitacion: nombreHab,
                    fechaIngreso: sel.fechaInicio,
                    fechaEgreso: sel.fechaFin
                });
            }

            if (contexto === 'reservar') {
                sessionStorage.setItem('reservaData', JSON.stringify(dataFinal));
                window.location.href = '/reserva/confirmar';

            } else if (contexto === 'ocupar') {
                if (dataFinal.length > 1) {
                    mostrarError("La función 'OCUPAR' solo permite una habitación a la vez.");
                    return;
                }
                const sel = dataFinal[0];

                let conflictoReserva = false;
                let fConflicto = null;
                const celdas = document.querySelectorAll(`td[data-habitacion="${sel.nombreHabitacion}"]`);
                celdas.forEach(td => {
                    const f = td.getAttribute('data-fecha');
                    if (f >= sel.fechaIngreso && f <= sel.fechaEgreso && td.dataset.estado === 'RESERVADA') {
                        conflictoReserva = true;
                        if(!fConflicto) fConflicto = f;
                    }
                });

                if (conflictoReserva) {
                    mostrarModalReserva(sel.nombreHabitacion, fConflicto);
                    return;
                }

                mostrarOcupacionExitosa(sel);
            }
        });
    }

    function mostrarOcupacionExitosa(ocupacionData) {
        sessionStorage.setItem('ocupacionData', JSON.stringify(ocupacionData));

        const infoDiv = document.getElementById('ocupacionInfo');
        infoDiv.innerHTML = `
            <div style="text-align: left;">
                <div style="margin-bottom: 8px;"><strong>Habitación:</strong> ${ocupacionData.nombreHabitacion}</div>
                <div style="margin-bottom: 8px;"><strong>Período:</strong> ${formatoFecha(ocupacionData.fechaIngreso)} - ${formatoFecha(ocupacionData.fechaEgreso)}</div>
                <div><strong>Estado:</strong> <span style="color: #dc2626; font-weight: bold;">OCUPADA</span></div>
            </div>
        `;

        document.getElementById('ocupacionSuccessDialog').classList.add('active');

        const keyHandler = (e) => {
            document.removeEventListener('keydown', keyHandler);
            document.getElementById('ocupacionSuccessDialog').classList.remove('active');
            window.location.href = '/habitacion/ocupar';
        };

        document.addEventListener('keydown', keyHandler);
    }

    // --- Utilidades ---
    async function mostrarModalReserva(nombre, fecha) {
        let datos = { apellido: "NO DISPONIBLE", nombre: " - ", telefono: "Consulte en recepción" };
        try {
            const res = await fetch(`/api/habitaciones/reserva-detalle?nombre=${encodeURIComponent(nombre)}&fecha=${fecha}`);
            if (res.ok) datos = await res.json();
        } catch (e) { console.error(e); }

        document.getElementById('modalApellido').textContent = datos.apellido || 'Sin Datos';
        document.getElementById('modalNombre').textContent = datos.nombre || '';
        document.getElementById('modalTelefono').textContent = datos.telefono || '';

        const btnOcuparIgual = document.getElementById('btnOcuparIgual');
        const newBtn = btnOcuparIgual.cloneNode(true);
        btnOcuparIgual.parentNode.replaceChild(newBtn, btnOcuparIgual);

        newBtn.onclick = function() {
            let fIn, fEg, idHab, nombreHabitacion;

            if (seleccionesActivas.size === 1) {
                const sel = seleccionesActivas.values().next().value;
                fIn = sel.fechaInicio; fEg = sel.fechaFin;
                idHab = parseInt(sel.idHabitacion);
                nombreHabitacion = nombre;
            } else {
                fIn = inputDesde.value; fEg = inputHasta.value;
                idHab = parseInt(window.habitacionesMap[nombre]);
                nombreHabitacion = nombre;
            }

            const dataOcupacion = { idHabitacion: idHab, nombreHabitacion: nombreHabitacion, fechaIngreso: fIn, fechaEgreso: fEg };
            sessionStorage.setItem('ocupacionData', JSON.stringify(dataOcupacion));
            window.location.href = '/habitacion/ocupar';
        };

        const btnVolver = document.getElementById('btnVolverReserva');
        const newBtnVol = btnVolver.cloneNode(true);
        btnVolver.parentNode.replaceChild(newBtnVol, btnVolver);
        newBtnVol.onclick = function() { cerrarModal('modalReserva'); };

        document.getElementById('modalReserva').classList.add('active');
    }

    function cerrarModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function formatoFecha(iso) {
        const [y, m, d] = iso.split('-'); return `${d}/${m}/${y}`;
    }

    function mostrarError(msg, el) {
        if(msg) {
            errorText.textContent = msg; errorMsg.classList.remove('hidden'); if(el) el.focus();
        }
        else {
            errorMsg.classList.add('hidden');
        }
    }

    function limpiarTabla() {
        document.getElementById('bodyRows').innerHTML = ''; if(btnAccion) btnAccion.disabled = true;
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (inputDesde.value && inputHasta.value) cargarGrilla();
    });

</script>
</body>
</html>